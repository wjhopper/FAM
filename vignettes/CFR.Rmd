---
title: "'Cummulative Free Recall' Performance Analysis"
author: "Will Hopper"
date: "`r Sys.Date()`"
output: 
  html_document:
    fig_caption: yes
    toc: true
    toc_depth: 3
    css: custom.css
vignette: >
  %\VignetteIndexEntry{CFR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r knitr_setup, cache=FALSE,echo=FALSE, warning=F, include=FALSE, message=FALSE}
library(whoppeR)
library(reshape2)
library(ggplot2)
library(dplyr)
library(FAM)
library(grid)
library(gridExtra)
library(wesanderson)
library(tidyr)
library(pander)
library(effsize)
knitr::opts_chunk$set(echo = FALSE, warning=F, message=FALSE, fig.align='center')
```

```{r testonlyData}
CFR_tested <- filter(CFR_allSs,
                     list != 0, 
                     (score %in% 1 | intrusions %in% 1 | repeats %in% 1),
                     phase=='final' | (phase=='prac' & practice =='T')) %>%
    group_by(subject,phase,list) %>%
    mutate(testOrder = 1:n())

agg <- filter(CFR_allSs,
              list != 0, score== 1,
              phase=='final' | (phase=='prac' & practice =='T')) %>%
  ungroup() %>%
  mutate(RTrounded = round(RT,1)) %>%
  group_by(subject,phase,list) %>%
  mutate(testOrder = 1:n()) %>% 
  select(-order) %>%
  rename(order=testOrder) %>%
  ungroup() %>% 
  complete(subject,class,order, cond_list, fill=list(score=0)) %>%
  group_by(class,order) %>% 
  summarise(sd = sd(score),
            acc = mean(score),
            count = n(),
            MAD =mad(RT,na.rm=T,constant = 1),
            RT = median(RT,na.rm=TRUE)) %>% 
  mutate(unobs = (1-acc)*count)

repeats <- filter(CFR_allSs,
                  list != 0, repeats == 1,
                  phase=='final' | (phase=='prac' & practice =='T')) %>%
  group_by(class) %>%
  summarise(repeats = sum(repeats))
    
intrusions <- filter(CFR_allSs,
                  list != 0, intrusions == 1,
                  phase=='final' | (phase=='prac' & practice =='T')) %>%
  group_by(class) %>%
  summarise(intrusions = sum(intrusions))
```

## Subject Performance 
Left figure shows counts of correct recalls, repeats of correct recalls, and extra
list intrusions for each list by each type of list (study practice, test practice, no practice). Perfect performance is 15/15 correct. 

Right figure shows latency in seconds to pressing the first key when typing in the word, relative to the last key press of the previous word (or onset of the trial in the case of the first word.) Violin plots are gaussian kernel density estimates of the RT's, bandwidth of 1. 

```{r subject,results='asis',fig.width=11,fig.height=6}
accData <-CFR_tested  %>% group_by(subject,class,phase,practice,cond_list) %>%
  summarise(score=sum(score),
            intrusions = sum(intrusions),
            repeats = sum(repeats)) %>%
  melt(id.vars = c("subject","phase","cond_list","class"),
       measure.vars = c("score","intrusions","repeats"),
       value.name="count")
ymax <- max(CFR_tested$testOrder)


for (i in unique(CFR_tested$subject)){
  subAcc <- ggplot(data = filter(accData,subject ==i),
                   aes(x= cond_list, y=count,fill=variable)) +
    geom_bar(stat="identity") +
    facet_grid(class~.) +
    scale_y_continuous(limits=c(0,ymax)) + 
    scale_fill_manual("Response Type",
                      breaks= c("score","repeats","intrusions"),
                      labels =c(score = "Correct",
                                intrusions = "Intrusions",
                                repeats = "Repeated"),
                      values = wes_palette("Darjeeling")) +
    xlab("List")
  

  subTime <- ggplot(data = filter(CFR_tested,subject==i,score %in% 1),
                    aes(x = factor(cond_list),y=RT)) +
    geom_violin() +
    geom_point() +
    facet_grid(class~.) +
    xlab("List")
    

  cat('<h4 class="subid">', paste("Subject", i), '</h4>')
  grid.arrange(subAcc,subTime,ncol=2,nrow=1)

}
```

## Output Position Frequency and RT
```{r agg_plots,fig.width=11,fig.height=7}
aggAccPlot <- ggplot(data =agg,
                     aes(x=factor(order), y=acc,  group=class, color=class)) +
  geom_point(size = 2) +
  geom_line(size = .75) +
  geom_errorbar(aes(ymin = acc - sd/sqrt(count), 
                    ymax =acc + sd/sqrt(count)),
                linetype=1,
                width=.3) +   
  scale_y_continuous("Probability of Recalling at Least x Items") +  
  scale_x_discrete("Output Position (x)") + 
  scale_color_manual(name="Practice\nCondition",
                     labels=c("Baseline","Restudy","Test Practice"),
                     values = c('black', 'red', '#00cc00')) + 
  ggtitle("Data vs. PCR: Output Accuracy")

aggRTPlot <- ggplot(data = agg,
                    aes(x=factor(order), y=RT, group=class, color=class)) +
  geom_point(size =2) +
  geom_line(size =.75) +
  geom_errorbar(aes(ymin = RT-(1*MAD),
                    ymax = RT+(1*MAD)),
                linetype=1,
                width=.3) +  
  scale_y_continuous("Median Inter-Retreival Time of Item x") +
  scale_x_discrete("Output Position (x)") +
  scale_color_manual(name="Practice\nCondition",
                     labels=c("Baseline","Restudy","Test Practice"),
                     values = c('black', 'red', '#00cc00')) + 
  ggtitle("Data vs. PCR: Reaction Time")

grid.arrange(aggAccPlot,aggRTPlot,ncol=2,nrow=1)

```

## Grand Averages 
```{r averages, fig.width = 4, fig.height=4, results="markdown"}
averaged <- filter(CFR_allSs,
              list != 0, score== 1,
              phase=='final' | (phase=='prac' & practice =='T')) %>%
  ungroup() %>%
  mutate(RTrounded = round(RT,1)) %>%
  group_by(subject,phase,list) %>%
  mutate(testOrder = 1:n()) %>% 
  select(-order) %>%
  rename(order=testOrder) %>%
  ungroup() %>% 
  complete(subject,class,order, cond_list, fill=list(score=0)) %>%
  group_by(class) %>% 
  summarise(acc = mean(score),
            logRT = mean(log(RT),na.rm=TRUE),
            RT = mean(RT,na.rm=TRUE)) %>% 
  mutate(class = factor(class)) %>%
  select(class, acc, logRT)

qplot(x=class,y=acc,data=averaged)
pander(averaged,style="rmarkdown")
```

## Accuracy Analysis

### Accuracy ANOVA 
```{r accAnova}
ANOVAdata <- filter(CFR_allSs,
              list != 0, score== 1,
              phase=='final' | (phase=='prac' & practice =='T')) %>%
  ungroup() %>%
  mutate(RTrounded = round(RT,1)) %>%
  group_by(subject,phase,list) %>%
  mutate(testOrder = 1:n()) %>% 
  select(-order) %>%
  rename(order=testOrder) %>%
  ungroup() %>% 
  complete(subject,class,order, cond_list, fill=list(score=0)) %>%
  group_by(subject,class) %>% 
  summarise(acc = mean(score),
            logRT = mean(log(RT),na.rm=TRUE),
            RT = mean(RT,na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(class = factor(class),
         subject = factor(subject)) %>%
  select(subject,class, acc, logRT, RT)

op <- options(contrasts = c("contr.sum", "contr.poly"))
accAnova <- aov(acc~class + Error(subject/class), data = ANOVAdata)  
pander(summary(accAnova))
```

### Accuracy Contrasts
```{r acc_contrasts}
acc_t_contrasts <- combn(c("np","sp","tp"), 2, FUN = t_summary, simplify=FALSE,
                        formula = logRT ~ class, data = ANOVAdata, paired=TRUE)
names(acc_t_contrasts) <- vapply(acc_t_contrasts, attr, FUN.VALUE = character(1), "pair")
acc_t_contrasts <- as.data.frame(do.call(rbind, acc_t_contrasts))
acc_t_contrasts$p <- p.adjust(acc_t_contrasts$p, method = "bonferroni")
pander(acc_t_contrasts)

```

## RT Analysis

### RT ANOVA
```{r rt_anova}
RTanova <- aov(logRT~class + Error(subject/class), data = ANOVAdata)  
pander(summary(RTanova))
```

### RT Contrasts
```{r RT_contrasts}
RT_t_contrasts <- combn(c("np","sp","tp"), 2, FUN = t_summary, simplify=FALSE,
                        formula = logRT ~ class, data = ANOVAdata, paired=TRUE)
names(RT_t_contrasts) <- vapply(RT_t_contrasts, attr, FUN.VALUE = character(1), "pair")
RT_t_contrasts <- as.data.frame(do.call(rbind, RT_t_contrasts))
RT_t_contrasts$p <- p.adjust(RT_t_contrasts$p, method = "bonferroni")
pander(RT_t_contrasts)

```

## RT by Reverse Output Order

Output order is computed only for correct responses, but any RT's are measured relative 
to the item output immediately prior, even if that item is an intrusion or repeat.

```{r revOrder,fig.cap="Error bars represent 2.5 and 97.5 percentiles."}
reversed <- CFR_tested %>% 
  filter(score %in% 1) %>% 
  mutate(testOrder = 1:n()) %>%
  arrange(desc(FP)) %>%
  group_by(subject,phase,list) %>%
  mutate(revOrder = rev(testOrder))
mRT <- reversed %>%
  group_by(revOrder) %>%
  summarise(meanRT = mean(RT),
            count = n(),
            upper = quantile(RT, .975),
            lower = quantile(RT, .025))
ggplot(data = mRT, 
       aes(x= factor(revOrder),y=meanRT)) +
  geom_point(aes(y=RT), data = reversed, 
             position = position_jitter(width = .2),
             color="black") + 
  geom_errorbar(mapping = aes(ymax=upper,ymin=lower),
                width=.25,color="red",size=.75) +
  geom_point(color="red") +
  geom_line(aes(x=1:15),color="red") + 
  geom_text(aes(label = count, y=-2.5)) +
  scale_x_discrete("Reverse Output Position",
                   labels = c("n", paste("n-",1:14,sep='')))+
  scale_y_continuous("Mean RT") +
  ggtitle("Inter-Retrieval Times by Reverse Output Position")
```

